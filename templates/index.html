<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>GPU Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" />
    <link href="https://cdn.datatables.net/2.0.3/css/dataTables.bootstrap5.min.css" rel="stylesheet" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸš€</text></svg>">
    <style>
        /* ç»†å¾®è°ƒæ•´ï¼Œé˜²æ­¢æ•°å­—å˜åŒ–æ—¶å¡ç‰‡æŠ–åŠ¨ */
        .gpu-card-val { font-variant-numeric: tabular-nums; }
        .card-footer .col-3 { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    </style>
</head>

<body class="bg-dark">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark border-bottom border-secondary">
        <div class="container ">
            <a class="navbar-brand" href="#" style="padding-left: 20px"><b>GPU</b> Monitor  </a>
            <div class="d-flex align-items-center gap-3 text-white small">
                <span id="connection-status" class="badge bg-secondary">Connecting...</span>
                <div id="update-timestamp">Waiting for data...</div>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <!-- GPU Cards Container -->
        <div class="row" id="gpu-cards-container">
            <!-- Cards will be injected here by JS -->
        </div>

        <!-- GPU Stat Table -->
        <div class="card mb-3">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-table me-2"></i>All Nodes and GPUs</span>
                    <button id="toggle-refresh" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-pause me-1"></i> Pause
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-bordered table-hover" id="dataTable" width="100%">
                        <thead>
                            <tr>
                                <th>Node</th>
                                <th>Device</th>
                                <th>Temp.</th>
                                <th>Util.</th>
                                <th>Memory (Used/Cap)</th>
                                <th>Power (Draw/Cap)</th>
                                <th>User Processes</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- GPU Temperature Legend -->
        <div class="card mt-3 mb-4">
            <div class="card-body p-3">
                <div class="d-flex align-items-center flex-wrap gap-3">
                    <h6 class="card-title mb-0 me-2"><i class="fas fa-palette me-2"></i>GPU Temperature Legend:</h6>
                    <div class="d-flex flex-wrap gap-2">
                        <span class="badge rounded-pill bg-danger px-2 py-1">Hot (>75Â°C)</span>
                        <span class="badge rounded-pill bg-warning text-dark px-2 py-1">Warm (50-75Â°C)</span>
                        <span class="badge rounded-pill bg-success px-2 py-1">Normal (25-50Â°C)</span>
                        <span class="badge rounded-pill bg-primary px-2 py-1">Cool (<25Â°C)</span>
                    </div>
                </div>
            </div>
        </div>

        <footer class="py-4 bg-dark">
            <div class="container text-center">
                        <small><a href="https://github.com/3355190239/GPU-Monitor" class="text-white" style="text-decoration: none"><i class="fab fa-github"></i> YuanZ/GPU Monitor | 2025</a></small>
            </div>
        </footer>

    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.3/js/dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.3/js/dataTables.bootstrap5.min.js"></script>

    <script>
        let dataTable;
        let isRefreshEnabled = true;
        let refreshTimeout;
        const REFRESH_RATE = 3000; // 3ç§’

        document.addEventListener('DOMContentLoaded', function () {
            // 1. åˆå§‹åŒ– DataTable
            dataTable = new DataTable('#dataTable', {
                paging: true,        // æ”¹å› trueï¼Œå¼€å¯åˆ†é¡µ
                pageLength: 25,      // é»˜è®¤æ¯é¡µæ˜¾ç¤º 10 æ¡
                lengthChange: true,  // å¼€å¯å·¦ä¸Šè§’çš„â€œæ¯é¡µæ˜¾ç¤ºXæ¡â€ä¸‹æ‹‰æ¡†
                searching: true,
                info: true,          // æ”¹å› trueï¼Œå¼€å¯å·¦ä¸‹è§’çš„â€œShowing x to x of xâ€
                order: [[0, 'asc'], [1, 'asc']],
                columnDefs: [
                    { className: 'small align-middle', targets: '_all' },
                    { width: '10%', targets: 0 },
                    { width: '15%', targets: 1 }, // Device
                    { width: '10%', targets: 2 },
                    { width: '10%', targets: 3 },
                    { width: '10%', targets: 4 }, // Memory
                    { width: '10%', targets: 5 },  // Power
                    { width: '35%', targets: 6 },
                ]
            });

            // 2. ç»‘å®šæš‚åœæŒ‰é’®
            const toggleBtn = document.getElementById('toggle-refresh');
            toggleBtn.addEventListener('click', function () {
                isRefreshEnabled = !isRefreshEnabled;
                if (isRefreshEnabled) {
                    toggleBtn.innerHTML = '<i class="fas fa-pause me-1"></i> Pause';
                    toggleBtn.classList.replace('btn-outline-danger', 'btn-outline-primary');
                    fetchData(); // ç«‹å³æ¢å¤
                } else {
                    toggleBtn.innerHTML = '<i class="fas fa-play me-1"></i> Resume';
                    toggleBtn.classList.replace('btn-outline-primary', 'btn-outline-danger');
                    clearTimeout(refreshTimeout);
                }
            });

            // 3. å¼€å§‹ç¬¬ä¸€æ¬¡æŠ“å–
            fetchData();
        });

        // === æ ¸å¿ƒè½®è¯¢é€»è¾‘ ===
        async function fetchData() {
            const statusBadge = document.getElementById('connection-status');

            try {
                const response = await fetch('/api/gpustat/all');
                if (!response.ok) throw new Error("Server Error");

                const data = await response.json();

                // æ›´æ–°ç•Œé¢
                updateCards(data);
                updateTable(data);

                // æ›´æ–°çŠ¶æ€æ 
                const now = new Date();
                document.getElementById('update-timestamp').textContent = now.toLocaleTimeString();
                statusBadge.className = 'badge bg-success';
                statusBadge.textContent = 'Connected';

            } catch (error) {
                console.error("Fetch failed:", error);
                statusBadge.className = 'badge bg-danger';
                statusBadge.textContent = 'Disconnected';
            } finally {
                // åªæœ‰å½“å¼€å…³å¼€å¯æ—¶ï¼Œæ‰æ³¨å†Œä¸‹ä¸€æ¬¡è½®è¯¢ (é€’å½’è°ƒç”¨)
                if (isRefreshEnabled) {
                    refreshTimeout = setTimeout(fetchData, REFRESH_RATE);
                }
            }
        }

        // === å¡ç‰‡æ›´æ–°é€»è¾‘ (Diff æ›´æ–°ï¼Œä¸é‡ç»˜) ===
        function updateCards(gpustats) {
            const container = document.getElementById('gpu-cards-container');

            // ç”¨ä¸€ä¸ª Set è®°å½•æœ¬æ¬¡æ›´æ–°å­˜åœ¨çš„å¡ç‰‡ IDï¼Œç”¨äºåç»­æ¸…ç†æ‰çº¿çš„æœºå™¨
            const activeCardIds = new Set();

            gpustats.forEach(node => {
                node.gpus.forEach(gpu => {
                    // ç”Ÿæˆå”¯ä¸€ ID: nodeName-gpuIndex
                    // ç®€å•çš„æ¸…ç†ç‰¹æ®Šå­—ç¬¦é˜²æ­¢ ID éæ³•
                    const safeHost = node.hostname.replace(/[^a-zA-Z0-9]/g, '');
                    const cardId = `card-${safeHost}-${gpu.index}`;
                    activeCardIds.add(cardId);

                    let cardEl = document.getElementById(cardId);

                    // è®¡ç®—é¢œè‰²
                    const temp = gpu['temperature.gpu'];
                    let colorClass = 'bg-primary'; // Cool
                    if (temp > 75) colorClass = 'bg-danger';     // Hot
                    else if (temp > 50) colorClass = 'bg-warning'; // Warm
                    else if (temp > 25) colorClass = 'bg-success'; // Normal

                    // å¦‚æœæ˜¯ connection error
                    if (node.error || gpu.index === "Err") colorClass = 'bg-secondary';

                    // tooltip å†…å®¹
                    const tooltipContent = `
                        <div class='text-start small'>
                            <strong>Node:</strong> ${node.hostname}<br>
                            <strong>Device:</strong> ${gpu.name} [${gpu.index}]<br>
                            <strong>Processes:</strong><br>${gpu['user_processes'] || 'None'}
                        </div>
                    `;

                    if (!cardEl) {
                        // === åˆ›å»ºæ–°å¡ç‰‡ ===
                        const html = `
                        <div class="col-xl-3 col-md-4 col-sm-6 mb-3 fade-in-card" id="${cardId}">
                            <div class="card text-white ${colorClass} h-100 shadow-sm">
                                <div class="card-body pb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div class="fw-bold"><i class="fas fa-server me-1"></i> ${node.hostname}</div>
                                        <span class="badge bg-dark bg-opacity-25 gpu-index">#${gpu.index}</span>
                                    </div>
                                    <div class="small text-truncate mb-2" title="${gpu.name}">${gpu.name}</div>
                                    <div class="d-flex justify-content-between small">
                                        <span>Power: <span class="gpu-power fw-bold">${gpu['power.draw']}</span>/${gpu['enforced.power.limit']}W</span>
                                    </div>
                                </div>
                                <div class="card-footer text-white small bg-black bg-opacity-10 border-0">
                                    <div class="row text-center g-1">
                                        <div class="col-3" title="Temp">
                                            <i class="fas fa-thermometer-half"></i> <span class="gpu-temp fw-bold">${gpu['temperature.gpu']}</span>Â°C
                                        </div>
                                        <div class="col-3" title="Memory">
                                            <i class="fas fa-memory"></i> <span class="gpu-mem fw-bold">${gpu.memory}</span>%
                                        </div>
                                        <div class="col-3" title="Util">
                                            <i class="fas fa-tachometer-alt"></i> <span class="gpu-util fw-bold">${gpu['utilization.gpu']}</span>%
                                        </div>
                                        <div class="col-3" title="Users">
                                            <i class="fas fa-users"></i> <span class="gpu-users fw-bold">${gpu.users}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                        container.insertAdjacentHTML('beforeend', html);
                        cardEl = document.getElementById(cardId); // è·å–åˆšæ’å…¥çš„å…ƒç´ å¼•ç”¨

                        // åˆå§‹åŒ– Tooltip
                        new bootstrap.Tooltip(cardEl.querySelector('.card'), {
                            html: true,
                            title: tooltipContent
                        });

                    } else {
                        // === æ›´æ–°ç°æœ‰å¡ç‰‡ ===
                        const cardInner = cardEl.querySelector('.card');

                        // 1. æ›´æ–°èƒŒæ™¯è‰² (å¦‚æœå˜äº†)
                        // ç§»é™¤æ—§çš„ bg-* ç±»ï¼Œæ·»åŠ æ–°çš„
                        cardInner.className = cardInner.className.replace(/bg-(primary|success|warning|danger|secondary)/, colorClass);

                        // 2. æ›´æ–°æ–‡æœ¬æ•°å€¼
                        cardEl.querySelector('.gpu-power').textContent = gpu['power.draw'];
                        cardEl.querySelector('.gpu-temp').textContent = gpu['temperature.gpu'];
                        cardEl.querySelector('.gpu-mem').textContent = gpu.memory;
                        cardEl.querySelector('.gpu-util').textContent = gpu['utilization.gpu'];
                        cardEl.querySelector('.gpu-users').textContent = gpu.users;

                        // 3. æ›´æ–° Tooltip (Bootstrap 5 æ–¹å¼)
                        const tooltip = bootstrap.Tooltip.getInstance(cardInner);
                        if(tooltip) {
                            tooltip.setContent({ '.tooltip-inner': tooltipContent });
                        }
                    }
                });
            });

            // æ¸…ç†å·²ç»æ¶ˆå¤±çš„æ˜¾å¡ï¼ˆé˜²æ­¢æ‹”æ‰æ˜¾å¡åè¿˜æ˜¾ç¤ºï¼‰
            Array.from(container.children).forEach(child => {
                if (!activeCardIds.has(child.id)) {
                    child.remove();
                }
            });
        }

        // === è¡¨æ ¼æ›´æ–°é€»è¾‘ (ä¿æŒçŠ¶æ€) ===
        function updateTable(gpustats) {
            // å‡†å¤‡æ–°æ•°æ®
            const newData = [];
            gpustats.forEach(node => {
                node.gpus.forEach(gpu => {
                    newData.push([
                        node.hostname,
                        `[${gpu.index}] ${gpu.name}`,
                        `${gpu['temperature.gpu']}Â°C`,
                        `<div class="progress" style="height: 20px; position: relative;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: ${gpu['utilization.gpu']}%"></div>
                            <span style="position: absolute; width: 100%; text-align: center; color: black; font-size: 0.8rem; line-height: 20px;">${gpu['utilization.gpu']}%</span>
                        </div>`,
                        `${gpu.memory}% <span class="text-muted small">(${gpu['memory.used']}/${gpu['memory.total']})</span>`,
                        `${gpu['power.draw']} / ${gpu['enforced.power.limit']} W`,
                        `<span class="text-truncate d-block" style="max-width: 400px;" title="${gpu['user_processes']}">${gpu['user_processes']}</span>`
                    ]);
                });
            });

            // DataTables ä¼˜åŒ–æ›´æ–°ï¼š
            // åªæœ‰å½“è¡Œæ•°ä¸ä¸€è‡´ï¼Œæˆ–è€…ç”¨æˆ·ä¸åœ¨äº¤äº’æ—¶ï¼Œæ‰å…¨é‡é‡ç»˜æ¯”è¾ƒç®€å•ã€‚
            // ä½†ä¸ºäº†â€œä¸æ”¹ä»£ç â€çš„åˆè¡·ï¼Œæˆ‘ä»¬ä½¿ç”¨ clear + add + draw(false)
            // draw(false) æ˜¯å…³é”®ï¼Œå®ƒä¿æŒäº†åˆ†é¡µä½ç½®ã€‚

            dataTable.clear();
            dataTable.rows.add(newData);
            dataTable.draw(false);
        }
    </script>
</body>
</html>
